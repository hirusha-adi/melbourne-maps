<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Melbourne Transport Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        /* Popup content styling */
        .popup-content {
            max-width: 220px;
        }

        .popup-title {
            font-weight: bold;
            margin-bottom: 6px;
        }

        .popup-thumb {
            max-width: 200px;
            max-height: 120px;
            width: 100%;
            height: auto;
            border-radius: 4px;
            cursor: pointer;
            display: block;
        }

        /* Modal overlay */
        #image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            justify-content: center;
            align-items: center;
        }

        #image-modal .modal-content {
            position: relative;
            background: #fff;
            padding: 12px 16px 16px;
            border-radius: 6px;
            max-width: 90vw;
            max-height: 85vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #image-modal .modal-title {
            font-weight: bold;
            margin-bottom: 4px;
        }

        #image-modal .modal-close {
            position: absolute;
            top: 6px;
            right: 10px;
            border: none;
            background: transparent;
            font-size: 20px;
            cursor: pointer;
        }

        /* Container that clips the zoomed image */
        #panzoom-container {
            flex: 1;
            max-height: 70vh;
            min-height: 300px;
            overflow: hidden;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #modal-image {
            max-width: 100%;
            max-height: 100%;
            display: block;
            cursor: grab;
        }

        #modal-image:active {
            cursor: grabbing;
        }

        .zoom-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 4px;
        }

        .zoom-controls button {
            padding: 6px 10px;
            border-radius: 4px;
            border: 1px solid #ccc;
            background: #f5f5f5;
            cursor: pointer;
            font-size: 14px;
        }

        .zoom-controls button:hover {
            background: #e5e5e5;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <!-- Image Modal -->
    <div id="image-modal">
        <div class="modal-content">
            <button class="modal-close" id="modal-close">&times;</button>
            <div class="modal-title" id="modal-title"></div>

            <div id="panzoom-container">
                <img id="modal-image" src="" alt="" />
            </div>

            <div class="zoom-controls">
                <button id="zoom-out">-</button>
                <button id="zoom-reset">Reset</button>
                <button id="zoom-in">+</button>
            </div>
        </div>
    </div>

    <!-- jQuery 2.x (compatible with panzoom) -->
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <!-- jQuery Mousewheel (for scroll zoom) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-mousewheel/3.1.13/jquery.mousewheel.min.js"></script>
    <!-- jQuery Panzoom (for zoom + drag) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.panzoom/3.2.2/jquery.panzoom.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Create the map immediately with a default (Melbourne) view
        const map = L.map('map').setView([-37.8136, 144.9631], 12);

        // Now it's safe to add layers â€“ map is defined
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution:
                '&copy; <a href="https://informati.cc" target="_blank">Hirusha Adikari</a>'
        }).addTo(map);

        // Try to recenter on user's location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;
                    map.setView([lat, lng], 14);
                },
                () => {
                    console.warn('Geolocation not allowed or failed, using default Melbourne view.');
                }
            );
        } else {
            console.warn('Geolocation not supported, using default Melbourne view.');
        }


        // Build popup HTML with title + thumbnail
        function buildPopupHtml(title, imageUrl) {
            return '' +
                '<div class="popup-content">' +
                '  <div class="popup-title">' + title + '</div>' +
                '  <img ' +
                '    src="' + imageUrl + '" ' +
                '    alt="' + title + '" ' +
                '    class="popup-thumb" ' +
                '    data-image-url="' + imageUrl + '" ' +
                '    data-image-title="' + title + '" ' +
                '  />' +
                '</div>';
        }

        // Custom marker icons
        const tramIcon = L.icon({
            iconUrl: 'icons/tram.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [-5, -28]
        });

        const busIcon = L.icon({
            iconUrl: 'icons/bus.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -28]
        });

        var locations;
        fetch('/data.json')
            .then(response => response.json())
            .then(locations => {
                locations.forEach(loc => {

                    let iconToUse = null;
                    if (loc.type === "tram") iconToUse = tramIcon;
                    if (loc.type === "bus") iconToUse = busIcon;

                    L.marker([loc.lat, loc.lng], { icon: iconToUse })
                        .addTo(map)
                        .bindPopup(buildPopupHtml(loc.title, loc.imageUrl));
                });
            })
            .catch(err => console.error("Failed to load /data.json:", err));


        // Modal + panzoom logic
        var $pzImage = null;

        function initPanzoom() {
            var $img = $('#modal-image');

            // Destroy existing panzoom if any
            try {
                $img.panzoom('destroy');
            } catch (e) {
                // ignore if not initialised
            }

            // Initialise panzoom on the image
            $pzImage = $img.panzoom({
                minScale: 1,
                maxScale: 5,
                contain: 'invert',
                increment: 0.2
            });

            var $container = $('#panzoom-container');

            // Scroll zoom
            $container.off('mousewheel.panzoom').on('mousewheel.panzoom', function (e) {
                e.preventDefault();
                // mousewheel plugin: e.deltaY
                var delta = e.deltaY;
                var zoomOut = delta < 0; // wheel down -> zoom out
                $pzImage.panzoom('zoom', zoomOut, {
                    increment: 0.15,
                    focal: e
                });
            });
        }

        // Open modal when thumbnail is clicked
        $(document).on('click', '.popup-thumb', function () {
            var imageUrl = $(this).data('image-url');
            var title = $(this).data('image-title');

            $('#modal-image').attr('src', imageUrl);
            $('#modal-title').text(title);
            $('#image-modal').css('display', 'flex'); // flex for centering

            // Wait a tick so the image is laid out, then init panzoom
            setTimeout(initPanzoom, 50);
        });

        // Close modal on close button
        $('#modal-close').on('click', function (e) {
            e.stopPropagation();
            $('#image-modal').hide();
        });

        // Optional: close modal when clicking outside the modal content
        $('#image-modal').on('click', function (e) {
            if (e.target.id === 'image-modal') {
                $('#image-modal').hide();
            }
        });

        // Zoom controls
        $('#zoom-in').on('click', function (e) {
            e.preventDefault();
            if ($pzImage) {
                $pzImage.panzoom('zoom', false, { increment: 0.2 });
            }
        });

        $('#zoom-out').on('click', function (e) {
            e.preventDefault();
            if ($pzImage) {
                $pzImage.panzoom('zoom', true, { increment: 0.2 });
            }
        });

        $('#zoom-reset').on('click', function (e) {
            e.preventDefault();
            if ($pzImage) {
                $pzImage.panzoom('reset');
            }
        });
    </script>
</body>

</html>